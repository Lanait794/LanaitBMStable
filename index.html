<!-- 見出しだけ差し替え -->
<table class="table table-light table-striped table-hover" id="table_int"></table>

<script>
  $(document).ready(function () {
    $.getJSON($("meta[name=bmstable]").attr("content"), function (header) {
      $.getJSON(header.data_url, function (information) {
        makeBMSTable(information, header.symbol);
      });
    });
  });

  // 文字列安全化
  function esc(s){ return (s==null?"":String(s))
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  function linkCell(url, text){
    if(!url) return "";
    return "<a href='"+esc(url)+"' target='_blank' rel='noopener'>"+esc(text||"リンク")+"</a>";
  }

  function makeBMSTable(info, mark) {
    var obj = $("#table_int");
    obj.html("");
    $(
      "<thead class='table-dark'><tr>" +
        "<th>level</th><th>title</th><th>作者</th><th>譜面作者</th>" +
        "<th>BPM</th><th>T/N</th><th>comment</th><th>本体</th><th>差分</th>" +
        "<th>md5</th><th>sha256</th>" +
      "</tr></thead><tbody>"
    ).appendTo(obj);

    var x = "", count = 0, sep = null;

    for (var i = 0; i < info.length; i++) {
      // ===== キーのゆるいマッピング =====
      var level   = info[i].level;
      var title   = info[i].title || info[i].name;
      var artist  = info[i].composer || info[i].artist || info[i].作者;          // 作曲者
      var charter = info[i].charter  || info[i].譜面作者 || info[i].chart_author; // 譜面作者
      var bpm     = info[i].bpm || info[i].BPM;
      var tn      = info[i].tn  || info[i]["T/N"] || info[i].keys;               // 同時押し/TN等
      var comment = info[i].comment || info[i].備考;
      var bodyUrl = info[i].body    || info[i].本体 || info[i].url || info[i].source;
      var diffUrl = info[i].diff    || info[i].差分 || info[i].difference;
      var md5     = info[i].md5;
      var sha256  = info[i].sha256 || info[i].sha;

      // レベル見出しの区切り行
      if (x != level) {
        if (sep != null) {
          sep.html("<td colspan='11'><b>" + esc(mark + x) + " (" + count + "譜面)</b></td>");
        }
        sep = $("<tr class='table-dark' style='text-align:center' id='" + esc(mark + level) + "'></tr>");
        sep.appendTo(obj);
        count = 0;
        x = level;
      }

      // タイトルはLR2IRリンク（md5がある場合）／なければ plain
      var titleCell = md5
        ? "<a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5="+esc(md5)+"' target='_blank'>"+esc(title)+"</a>"
        : esc(title);

      var tr = $("<tr></tr>");
      tr.append("<td width='5%'>"  + esc(mark + level) + "</td>");
      tr.append("<td width='22%'>" + titleCell + "</td>");
      tr.append("<td width='12%'>" + esc(artist)  + "</td>");
      tr.append("<td width='12%'>" + esc(charter) + "</td>");
      tr.append("<td width='7%'>"  + esc(bpm)     + "</td>");
      tr.append("<td width='6%'>"  + esc(tn)      + "</td>");
      tr.append("<td width='16%'>" + esc(comment) + "</td>");
      tr.append("<td width='5%'>"  + linkCell(bodyUrl, "本体") + "</td>");
      tr.append("<td width='5%'>"  + linkCell(diffUrl, "差分") + "</td>");
      tr.append("<td width='10%'><code>"+esc(md5||"")+"</code></td>");
      tr.append("<td width='10%'><code>"+esc(sha256||"")+"</code></td>");
      tr.appendTo(obj);

      count++;
    }

    if (sep != null) {
      sep.html("<td class='table-dark' style='text-align:center' colspan='11'><b>" + esc(mark + x) + " (" + count + "譜面)</b></td>");
    }

    $("</tbody>").appendTo(obj);
  }
</script>
